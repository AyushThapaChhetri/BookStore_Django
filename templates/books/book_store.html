{% extends 'base/base.html' %}
{% load static %}

{% block content %}
    <div class="flex flex-col grow  items-center justify-between p-4 md:p-10 bg-gray-100 gap-4  w-full">
        <div class="flex flex-col w-full gap-4 h-full max-w-[1536px]">
            <div class="w-full">
                {#                <form method="get" class="w-full ">#}
                <label for="default-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">Search</label>
                <div class="relative">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                  stroke-width="2"
                                  d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                        </svg>
                    </div>

                    <input type="text" name="q" id="default-search"
                           class="block w-full p-4 ps-10 text-sm text-gray-900 border-0 shadow-lg outline-none focus:border-[0.5px]   rounded-lg bg-gray-50   "
                           placeholder="Search Title, Author, Publisher..."/>
                    <button type="submit"
                            class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                        Search
                    </button>
                </div>
                {#                </form>#}
            </div>
            <div class="flex grow ">
                <div class="filter-container w-[30%] md:block hidden">
                    {#                    {{ query_string }}#}
                    {% include 'books/components/filter_card.html' with min_price_value=min_price_value max_price_value=max_price_value  prefix="notDrawer" %}
                </div>
                <div class="flex flex-col  gap-4 w-full  ">
                    <div class="flex justify-between">
                        <div class="flex flex-col gap-2">
                            <h1 class="font-lexend text-3xl font-medium">
                                Store
                            </h1>
                            <!-- drawer init and toggle -->
                            <div class="text-center md:hidden block">
                                <button class="flex items-center gap-2 text-gray-800 hover:text-white  hover:bg-gray-300
                                focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-2 py-2.5 mb-2"
                                        type="button" data-drawer-target="drawer-example"
                                        data-drawer-show="drawer-example" aria-controls="drawer-example">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5" stroke="currentColor" class="size-6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
                                    </svg>

                                    Show drawer
                                </button>
                            </div>

                            <!-- drawer component -->
                            <div id="drawer-example"
                                 class="fixed top-0 left-0 z-40 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-white w-80 dark:bg-gray-100"
                                 tabindex="-1" aria-labelledby="drawer-label">
                                <h5 id="drawer-label "
                                    class="inline-flex  items-center mb-4 text-base font-semibold
                                    text-gray-500 dark:text-gray-600 gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5" stroke="currentColor" class="size-6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M6 13.5V3.75m0 9.75a1.5 1.5 0 0 1 0 3m0-3a1.5 1.5 0 0 0 0 3m0 3.75V16.5m12-3V3.75m0 9.75a1.5 1.5 0 0 1 0 3m0-3a1.5 1.5 0 0 0 0 3m0 3.75V16.5m-6-9V3.75m0 3.75a1.5 1.5 0 0 1 0 3m0-3a1.5 1.5 0 0 0 0 3m0 9.75V10.5"/>
                                    </svg>

                                    Filter
                                </h5>
                                <button type="button" data-drawer-hide="drawer-example" aria-controls="drawer-example"
                                        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 flex items-center justify-center dark:hover:bg-gray-600 dark:hover:text-white">
                                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                         fill="none" viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                    </svg>
                                    <span class="sr-only">Close menu</span>
                                </button>

                                <div class="filter-container">

                                    {% include 'books/components/filter_card.html' with min_price_value=min_price_value max_price_value=max_price_value prefix="drawer" %}

                                </div>
                            </div>
                        </div>
                        <div class="flex items-center">

                            <select id="sortBy_item"
                                    class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg
                   focus:ring-blue-500 focus:border-blue-500 block w-fit p-2.5">
                                <option value="price_asc" {% if request.GET.sort == "price_asc" %}selected{% endif %}>
                                    Price (Low → High)
                                </option>
                                <option value="price_desc" {% if request.GET.sort == "price_desc" %}selected{% endif %}>
                                    Price (High → Low)
                                </option>
                                <option value="quantity_desc"
                                        {% if request.GET.sort == "quantity_desc" %}selected{% endif %}>
                                    Stock (High → Low)
                                </option>
                                <option value="quantity_asc"
                                        {% if request.GET.sort == "quantity_asc" %}selected{% endif %}>
                                    Stock (Low → High)
                                </option>
                                <option value="created_desc"
                                        {% if request.GET.sort == "created_desc" %}selected{% endif %}>
                                    Created (Newest)
                                </option>
                                <option value="created_asc"
                                        {% if request.GET.sort == "created_asc" %}selected{% endif %}>
                                    Created (Oldest)
                                </option>
                            </select>
                        </div>
                    </div>
                    <div id="store-book-items"
                         class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4  min-h-[450px]
">

                        {% if paginated_books %}
                            {% include 'books/components/book_cards.html' with paginated_books=paginated_books %}
                        {% else %}
                            No Books Available
                        {% endif %}

                    </div>

                    {% if paginated_books %}
                        {% include 'books/components/pagination_div.html' with paginated_books=paginated_books %}
                    {% endif %}

                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block extra_js %}
    <script>


        const searchInput = document.getElementById('default-search')
        const storeContent = document.getElementById('store-book-items')
        const paginationContent = document.getElementById('store-paginationContent')
        let debounceTimer;

        // Unified fetch function for all filters/sorting/search
        async function fetchBooks(customUrl) {
            const url = customUrl || new URL(window.location.href);
            {#console.log('fetch url: ', url);#}

            try {
                const response = await axios.get("{% url 'book_store' %}", {
                    params: {
                        q: url.searchParams.get("q") || "",
                        min_price: url.searchParams.get("min_price") || "",
                        max_price: url.searchParams.get("max_price") || "",
                        sort: url.searchParams.get("sort") || "",
                        page: url.searchParams.get("page") || 1,
                        limit: url.searchParams.get("limit") || "{{ limit }}"
                    },
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });
                if (storeContent) {
                    storeContent.innerHTML = response.data.cards;
                }
                if (paginationContent) {
                    paginationContent.innerHTML = response.data.pagination;
                }
                {#console.log("Min price from backend", response.data.min_price)#}
                {#console.log("Max price from backend", response.data.max_price)#}

                const minVal = response.data.min_price;
                const maxVal = response.data.max_price;
                const search_min_price_limit = response.data.search_min_price_limit;
                const search_max_price_limit = response.data.search_max_price_limit;

                {#console.log("minvalue: ", minVal);#}

                url.searchParams.set("min_price", minVal);
                url.searchParams.set("max_price", maxVal);

                {#updates browser url to new path without causing reload#}
                history.pushState({}, "", url);


                //  Sync filters across ALL containers
                {#const minVal = url.searchParams.get("min_price");#}
                {#const maxVal = url.searchParams.get("max_price");#}
                {#console.log("db max", search_max_price_limit);#}
                {##}
                {#console.log('min val and max value from backend: ', minVal, maxVal);#}

                {#if (minVal !== null && minVal !== undefined) console.log("mmmmmmmm");#}
                {#console.log(typeof minVal);#}
                {#console.log(typeof maxVal);#}

                if ((minVal !== null && minVal !== undefined) && maxVal) {
                    {#console.log('people: ')#}

                    document.querySelectorAll('.filter-container').forEach(container => {
                        const minInput = container.querySelector(".min_range");
                        const maxInput = container.querySelector(".max_range");
                        const minRangePrice = container.querySelector(".min_range_price");
                        const maxRangePrice = container.querySelector(".max_range_price");
                        const bar = container.querySelector(".bar");

                        {#console.log('where: ', maxInput.value)#}


                        if (minInput && maxInput) {
                            {#console.log('db max: ', search_max_price_limit)#}
                            minInput.value = minVal;
                            maxInput.value = maxVal;
                            minInput.min = search_min_price_limit;
                            maxInput.max = search_max_price_limit;
                            minInput.max = search_max_price_limit;
                            {##}
                            {#console.log('hello minInput: ', minInput);#}
                            {#console.log('hello maxInput: ', maxInput);#}
                            {#console.log('hello value: ', minInput.value);#}
                            {#console.log('hello value: ', maxInput.value);#}
                            {#console.log('hello value max: ', minInput.max);#}
                            {#console.log('hello value max: ', maxInput.max);#}


                            if (minRangePrice) minRangePrice.innerText = minVal;
                            if (maxRangePrice) maxRangePrice.innerText = maxVal;

                            {#const leftPercent = (minVal / minInput.max) * 100;#}
                            {#const rightPercent = (maxVal / maxInput.max) * 100;#}
                            const leftPercent = (minVal / minInput.max) * 100;
                            const rightPercent = (maxVal / maxInput.max) * 100;

                            {#console.log('leftPercent: ', leftPercent)#}
                            {#console.log('rightpercent: ', rightPercent)#}

                            if (bar) {
                                bar.style.left = leftPercent + "%";
                                bar.style.width = (rightPercent - leftPercent) + "%";
                            }
                        }
                    });
                }


            } catch
                (error) {
                console.error("Error fetching books:", error);
            }
        }

        // --- Limit dropdown ---
        function attachLimitListener() {
            const limitSelect = document.getElementById("rowsPerPage");
            if (!limitSelect) return;
            {#console.log("Limit listener");#}
            limitSelect.addEventListener("change", () => {
                {#console.log("limit value", limitSelect.value)#}
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set("limit", limitSelect.value);
                newUrl.searchParams.set("page", 1);
                fetchBooks(newUrl);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const url = new URL(window.location.href);

            // --- Restore search query ---
            const existingQuery = url.searchParams.get("q");
            if (existingQuery) searchInput.value = existingQuery;

            fetchBooks(url);


            // --- Search input debounce ---
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    {#url.searchParams.set("q", searchInput.value);#}
                    {#url.searchParams.set("page", 1);#}
                    {#fetchBooks();#}
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set("q", searchInput.value);
                    {#newUrl.searchParams.set("page", 1);#}
                    {#console.log('url: ', newUrl);#}
                    fetchBooks(newUrl);
                }, 500);
            });

            // --- Sorting ---
            const sortSelect = document.getElementById("sortBy_item");
            if (sortSelect) {
                sortSelect.addEventListener("change", () => {

                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set("sort", sortSelect.value);
                    {#newUrl.searchParams.set("page", 1);#}
                    {#console.log('url: ', newUrl);#}
                    fetchBooks(newUrl);


                });
            }


            {#limit change#}

            {#const limitSelect = document.getElementById("rowsPerPage_ajax");#}
            {#console.log('limit select: ', limitSelect)#}
            {#if (limitSelect) {#}
            {##}
            {#    console.log("Limit listener");#}
            {#    limitSelect.addEventListener("change", () => {#}
            {#        console.log("limit value", limitSelect.value)#}
            {#        const newUrl = new URL(window.location.href);#}
            {#        newUrl.searchParams.set("limit", limitSelect.value);#}
            {#        newUrl.searchParams.set("page", 1);#}
            {#        fetchBooks(newUrl);#}
            {#    });#}

            document.addEventListener('change', (e) => {
                if (e.target && e.target.id === "rowsPerPage_ajax") {
                    console.log("Limit changed:", e.target.value);

                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set("limit", e.target.value);
                    newUrl.searchParams.set("page", 1);

                    fetchBooks(newUrl);
                }
            });


            {#attachLimitListener();#}

            // --- Price slider and filter buttons ---
            const filterContainers = document.querySelectorAll('.filter-container');
            filterContainers.forEach(container => {
                const min_range_price = container.querySelector('.min_range_price');
                const max_range_price = container.querySelector('.max_range_price');
                const range_input = container.querySelectorAll('.range_input input');
                const bar = container.querySelector('.bar');
                const gap_number = 500;

                function updateBar(event) {
                    let min_val = parseInt(range_input[0].value);
                    let max_val = parseInt(range_input[1].value);

                    if (max_val - min_val < gap_number) {
                        if (event && event.target.classList.contains('min_range')) {
                            range_input[0].value = max_val - gap_number;
                            min_val = max_val - gap_number;
                        } else {
                            range_input[1].value = min_val + gap_number;
                            max_val = min_val + gap_number;
                        }
                    }

                    min_range_price.innerText = min_val;
                    max_range_price.innerText = max_val;

                    const leftPercent = (min_val / range_input[0].max) * 100;
                    const rightPercent = (max_val / range_input[1].max) * 100;

                    bar.style.left = leftPercent + '%';
                    bar.style.width = (rightPercent - leftPercent) + '%';
                }

                range_input.forEach(input => input.addEventListener('input', updateBar));
                updateBar();

                const filterButton = container.querySelector('.filter_price_button');
                if (filterButton) {
                    filterButton.addEventListener('click', () => {
                        {#console.log('button clicked');#}
                        const minVal = container.querySelector(".min_range").value;
                        const maxVal = container.querySelector(".max_range").value;

                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("min_price", minVal);
                        newUrl.searchParams.set("max_price", maxVal);

                        {#console.log('url: ', newUrl);#}
                        fetchBooks(newUrl);
                    });
                }
            });


            // 2 Card click navigation
            storeContent.addEventListener('click', (e) => {
                if (e.target.closest('.button_cart_add')) return // skip Add to Cart
                const card = e.target.closest('[data-href]')
                if (card) {
                    const href = card.dataset.href
                    if (href) window.location.href = href
                }
            })

            // Add to Cart listener
            storeContent.addEventListener('click', async (e) => {
                const button = e.target.closest('.button_cart_add');
                if (!button) return;
                e.stopPropagation(); // prevents card click
                e.preventDefault(); // prevents default anchor behavior
                {#console.log("buttonclicked");#}

                const bookUuid = button.dataset.bookUuid;


                try {
                    const response = await axios.post(
                        "{% url 'add_to_cart' %}",
                        new URLSearchParams({book_uuid: bookUuid}),
                        {
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        }
                    );

                    const data = response.data;

                    if (data.success) {
                        if (data.created) {
                            button.textContent = "Added";
                            setTimeout(() => {
                                button.outerHTML = `<a href="{% url 'book_cart' %}"
                        class="bg-blue-700 text-white text-center px-5 py-2.5 rounded-lg text-sm">
                        View Cart
                    </a>`;
                            }, 1500);
                        } else {
                            button.outerHTML = `<a href="{% url 'book_cart' %}"
                    class="bg-blue-700 text-white text-center px-5 py-2.5 rounded-lg text-sm">
                    View Cart
                </a>`;
                        }

                        async function updateCartCount() {
                            try {
                                let response = await axios.get('/carts/count/');


                                let data = await response.data.count;
                                const cartCount = document.querySelector("#cart-count");
                                if (cartCount) {

                                    cartCount.innerHTML = data;
                                }

                            } catch (e) {
                                {#console.log(e);#}
                                alert(`Error occured`);
                            }
                        }

                        await updateCartCount();
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    console.error("Error adding to cart:", error);
                    alert("Something went wrong. Please try again.");
                }
            });
        })
        ;


    </script>
{% endblock %}