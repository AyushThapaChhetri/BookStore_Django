{% extends 'books/admin/admin_base_list.html' %}
{% load permissions %}
{% load active_sidebar %}


{% block list_title %}
    {% if is_recycle_bin %}Book Recycle Bin{% else %}Book List{% endif %}

{% endblock %}

{% block list_heading %}
    {% if is_recycle_bin %}Deleted Books{% else %}Books{% endif %}
{% endblock %}

{% block list_description %}
    {% if is_recycle_bin %}
        A list of all deleted books. You can restore or permanently delete them.
    {% else %}
        A list of all the books including their title, author, pages and language.
    {% endif %}
{% endblock %}

{% block search_placeholder %}Search Titles, Author, Publisher{% endblock %}



{% block add_perm %}books.add_book{% endblock %}
{#{% block sort_title_asc %}Name{% endblock %}#}
{#{% block sort_title_desc %}Name{% endblock %}#}
{% block add_url %}{% url 'book_view' %}{% endblock %}
{% block entity_name %}Book{% endblock %}





{% block table_headers %}
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Cover</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Title</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Author(s)</th>
    {% if is_recycle_bin %}
        <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Deleted_By</th>
        <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Deleted_At</th>
    {% else %}

        <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Publication Date</th>
        <th class="p-3 text-sm font-semibold tracking-wide text-left">Stocks</th>
    {% endif %}
{% endblock %}
{% block columns_count %}6{% endblock %}
{% block table_body %}
    {% for book in paginated_books %}
        <tr class="{% if forloop.counter|divisibleby:2 %}bg-gray-300{% else %}bg-gray-50{% endif %}">
            <td class="p-3 text-sm text-gray-700"> {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}"
                     alt="{{ book.title }}"
                     class="h-10 w-8 object-cover"/>
            {% else %}
                <span class="italic text-gray-400">No cover available</span>
            {% endif %}</td>
            <td class="p-3 text-sm text-gray-700">{{ book.title }}</td>
            <td class="p-3 text-sm text-gray-700">
                {% for author in book.authors.all %}{{ author.name }}{% if not forloop.last %},
                {% endif %}{% endfor %}</td>

            {% if is_recycle_bin %}

                <td class="p-3 text-sm text-gray-700">{{ book.deleted_by.email|default:'-' }}</td>
                <td class="p-3 text-sm text-gray-700">{{ book.deleted_at|default:'-' }}</td>
            {% else %}
                <td class="p-3 text-sm text-gray-700">{{ book.publication_date|default:'-' }}</td>
                <td class="p-3 whitespace-nowrap text-sm text-gray-700">{% if book.stock %}
                    Rs {{ book.stock.price }} ({{ book.stock.stock_quantity }} left)
                {% else %}
                    Out of stock
                {% endif %}</td>
            {% endif %}

            <td class="p-3 text-sm text-gray-700">
                <div class="flex space-x-2 gap-1">
                    {% if is_recycle_bin %}
                        <!-- Recycle Bin Actions -->
                        <form method="post" action="{% url 'book_restore' book.uuid %}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="prevent-multi-click bg-green-600 hover:bg-green-800 text-white font-medium py-2 px-4 rounded">
                                Restore
                            </button>
                        </form>
                        {#                        <button type="button"#}
                        {#                                class="bg-red-600 hover:bg-red-800 text-nowrap text-white font-medium py-2 px-4 rounded"#}
                        {#                                onclick="openModal('{{ book.uuid }}', 'permanent_delete')">#}
                        {##}
                        {#                            Hard Delete#}
                        {#                        </button>#}
                    {% else %}
                        <button type="button"
                                class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded"
                                onclick="window.location.href='{% url 'book_detail_view' book.uuid %}'"
                        >
                            {#                            <a href="{% url 'book_detail_view' book.uuid %}">#}
                            View
                            {#                            </a>#}
                        </button>
                        {% if request.user|has_perm:"books.change_book" %}
                            <button
                                    type="button"
                                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                                    onclick="window.location.href='{% url 'book_view' book.uuid %}'"
                            >
                                {#                                <a href="{% url 'book_view' book.uuid %}">#}
                                Edit
                                {#                                </a>#}
                            </button>
                            <button
                                    type="button"
                                    class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                                    onclick="openModal('{{ book.uuid }}', 'delete')"
                            >
                                Delete
                            </button>
                        {% endif %}
                    {% endif %}
                </div>

            </td>
        </tr>

    {% empty %}
        <tr>
            <td colspan="6" class="text-center p-4 text-gray-500">
                {% if is_recycle_bin %}No deleted books found{% else %}No books found{% endif %}
            </td>
        </tr>
    {% endfor %}
{% endblock %}

{% block pagination %}
    {% with paginated_books as paginated_items %}
        {{ block.super }}
    {% endwith %}
{% endblock %}


{% block modals %}
    {#    {% if is_recycle_bin %}#}
    <!-- Permanent Delete Modal for Recycle Bin -->
    {#        <div id="permanent_deleteModal"#}
    {#             class="fixed inset-0 hidden justify-center items-center z-60 backdrop-blur-sm bg-white/10">#}
    {#            <div class="bg-white rounded-lg p-6 w-[90%] max-w-md">#}
    {#                <p class="text-lg text-gray-800">Are you sure you want to permanently delete this book? This action#}
    {#                    cannot#}
    {#                    be undone.</p>#}
    {#                <div class="flex justify-end gap-3">#}
    {#                    <button onclick="closeModal('permanent_delete')"#}
    {#                            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel#}
    {#                    </button>#}
    {#                    <form id="permanent_deleteForm" method="post" action="">#}
    {#                        {% csrf_token %}#}
    {#                        <input type="hidden" name="permanent_delete" value="1">#}
    {#                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">#}
    {#                            Yes, Delete Permanently#}
    {#                        </button>#}
    {#                    </form>#}
    {#                </div>#}
    {#            </div>#}
    {#        </div>#}
    {#    {% else %}#}

    <div id="deleteModal"
         class="fixed inset-0 hidden justify-center items-center z-60 backdrop-blur-sm bg-white/10">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-md">
            <p class="text-lg text-gray-800">Are you sure you want to delete this book?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('delete')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="delete" value="1">
                    <button type="submit" name="delete"
                            class="prevent-multi-click px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Yes, Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
    {#    {% endif %}#}
{% endblock %}

{% block search_url %}/books/search/{% endblock %}
{% block response_data_key %}books{% endblock %}
{% block modal_form_action %}
    /admin-panel/book/delete/
{% endblock %}
{#    {% if is_recycle_bin %}#}
{#    /admin-panel/book/permanent-delete/#}
{#    {% else %}#}
{#    {% endif %}#}


{% block base_script %}
    {{ block.super }}

    <script>
        {#console.log("Hello child");#}
        const isRecycleBin = {{ is_recycle_bin|yesno:"true,false" }};
        const csrfToken = "{{ csrf_token }}";

        function formatDate(dateStr) {
            if (!dateStr) return "-";

            const date = new Date(dateStr);

            // Month short with dot (e.g., Sept.)
            const month = date.toLocaleDateString("en-US", {month: "short"}) + ".";
            const day = date.getDate();
            const year = date.getFullYear();

            // Format hours + minutes in 12h clock with a.m./p.m.
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, "0");
            const ampm = hours >= 12 ? "p.m." : "a.m.";
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 â†’ 12

            return `${month} ${day}, ${year}, ${hours}:${minutes} ${ampm}`;
        }

        // Override the renderItems function for books
        function renderItems(books) {
            console.log('books: ', books);
            if (books.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No Rows Found</td></tr>`;
                return;
            }

            tableBody.innerHTML = books.map((book, index) => {
                const coverImage = book.cover_image
                    ? `<img src="${book.cover_image}" alt="${book.title}" class="h-10 w-8 object-cover"/>`
                    : `<span class="italic text-gray-400">No cover available</span>`;

                const authors = book.authors && book.authors.length
                    ? book.authors.join(", ")
                    : "-";

                const stockHtml = book.stock
                    ? `Rs ${book.stock.price} (${book.stock.stock_quantity} left)`
                    : "Out of stock";

                // Columns differ for recycle bin vs normal
                const extraCols = isRecycleBin
                    ? `
                    <td class="p-3 text-sm text-gray-700">${book.deleted_by || '-'}</td>
                    <td class="p-3 text-sm text-gray-700">${formatDate(book.deleted_at)}</td>
                `
                    : `
                    <td class="p-3 text-sm text-gray-700">${formatDate(book.publication_date)}</td>
                    <td class="p-3 whitespace-nowrap text-sm text-gray-700">
                        ${book.stock ? `Rs ${book.stock.price} (${book.stock.stock_quantity} left)` : "Out of stock"}
                    </td>
                `;

                // Actions differ too
                const actions = isRecycleBin
                    ? `
                    <form method="post" action="/admin-panel/books/restore/${book.uuid}/">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                        <button type="submit" class="prevent-multi-click bg-green-600 hover:bg-green-800 text-white font-medium py-2 px-4 rounded">
                            Restore
                        </button>
                    </form>
                `
                    : `
                    <a href="/admin-panel/books/detail/${book.uuid}" class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">View</a>
                    <a href="/admin-panel/book/edit/${book.uuid}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Edit</a>
                    <button onclick="openModal('${book.uuid}', 'delete')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete</button>
                `;

                return `
                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-300'}">
                    <td class="p-3 text-sm text-gray-700">${coverImage}</td>
                    <td class="p-3 text-sm text-gray-700">${book.title}</td>
                    <td class="p-3 text-sm text-gray-700">${authors}</td>
{#                    <td class="p-3 text-sm text-gray-700">${book.publication_date || '-'}</td>#}
{#                    <td class="p-3 text-sm text-gray-700">${formatDate(book.publication_date)}</td>#}
{#                    <td class="p-3 whitespace-nowrap text-sm text-gray-700">${stockHtml}</td>#}
                    ${extraCols}
                    <td class="p-3 text-sm text-gray-700">
                        <div class="flex space-x-2 gap-1">
                            {#<a href="/admin-panel/books/detail/${book.uuid}" class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">View</a>#}
                            {#<a href="/admin-panel/book/edit/${book.uuid}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Edit</a>#}
                            {#<button onclick="openModal('${book.uuid}', 'delete')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete</button>#}
                            ${actions}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
    </script>
{% endblock %}



