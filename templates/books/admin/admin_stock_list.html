{% extends 'books/admin/admin_base_list.html' %}
{% load permissions %}


{% block list_title %}Stock List{% endblock %}

{% block list_heading %}Stocks{% endblock %}

{% block list_description %}
    This section provides a detailed overview of all available books in
    stock, including
    key information
    such as the title, authors, number of pages, language, and current availability. It helps you
    quickly assess which books are ready for purchase or restocking.
{% endblock %}


{% block search_placeholder %}Search Titles, Publisher{% endblock %}

{% block sort_options %}
    <option value="price_asc" {% if request.GET.sort == "price_asc" %}selected{% endif %}>
        Price (Low → High)
    </option>
    <option value="price_desc" {% if request.GET.sort == "price_desc" %}selected{% endif %}>
        Price (High → Low)
    </option>
    <option value="quantity_desc" {% if request.GET.sort == "quantity_desc" %}selected{% endif %}>
        Stock (High → Low)
    </option>
    <option value="quantity_asc" {% if request.GET.sort == "quantity_asc" %}selected{% endif %}>
        Stock (Low → High)
    </option>
    <option value="available_first" {% if request.GET.sort == "available_first" %}selected{% endif %}>
        Available First
    </option>
    <option value="unavailable_first" {% if request.GET.sort == "unavailable_first" %}selected{% endif %}>
        Unavailable First
    </option>
    <option value="restock_desc" {% if request.GET.sort == "restock_desc" %}selected{% endif %}>
        Recently Restocked
    </option>
    <option value="restock_asc" {% if request.GET.sort == "restock_asc" %}selected{% endif %}>
        Oldest Restock
    </option>
    <option value="created_desc" {% if request.GET.sort == "created_desc" %}selected{% endif %}>
        Created (Newest)
    </option>
    <option value="created_asc" {% if request.GET.sort == "created_asc" %}selected{% endif %}>
        Created (Oldest)
    </option>
{% endblock %}

{% block add_perm %}stocks.add_stock{% endblock %}
{% block sort_title_asc %}Titles{% endblock %}
{% block sort_title_desc %}Titles{% endblock %}
{% block add_button %}{% endblock %}


{% block table_headers %}
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Cover</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Title</th>
    {#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Publisher</th>#}
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide  text-center">Price</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide  text-center">Discount</th>
    <th class="py-3 px-5 text-sm font-semibold tracking-wide  text-center">Quantity</th>
{% endblock %}
{% block columns_count %}7{% endblock %}
{% block table_body %}
    {% for stock in paginated_stocks %}
        <tr class="{% if forloop.counter|divisibleby:2 %}bg-gray-300{% else %}bg-gray-50{% endif %}">
            <td class="p-3 text-sm text-gray-700"> {% if stock.book.cover_image %}
                <img src="{{ stock.book.cover_image.url }}"
                     alt="{{ stock.book.title }}"
                     class="h-10 w-8 object-cover"/>
            {% else %}
                <span class="italic text-gray-400">No cover available</span>
            {% endif %}</td>
            <td class="p-3 text-sm text-gray-700">{{ stock.book.title }}</td>
            {#            <td class="p-3 text-sm text-gray-700">{{ stock.book.publisher.name|default:'-' }}</td>#}
            <td class="p-3 text-sm text-gray-700 text-center">
                {% if stock.price %}
                    Rs {{ stock.price|floatformat:"-2" }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="p-3 text-sm text-gray-700 text-center">{% if stock.discount_percentage %}
                {{ stock.discount_percentage|floatformat:-2 }}% → Rs
                {{ stock.discount_amount|floatformat:"2"|floatformat:"g" }}
            {% else %}
                -
            {% endif %}</td>
            <td class="p-3 text-sm text-gray-700 text-center">{{ stock.stock_quantity|default:'-' }}</td>
            {#            <td class="p-3 text-sm text-gray-700">{% if stock.is_available %}#}
            {#                <span class="text-green-600 font-semibold">Yes</span>#}
            {#            {% else %}#}
            {#    <span class="text-red-600 font-semibold">No</span>#}
            {#    {% endif %}</td>#}
            {#            <td class="p-3 text-sm text-gray-700">{{ stock.last_restock_date|default:"-" }}</td>#}
            <td class="p-3 text-sm text-gray-700">
                <div class="flex  space-x-2 gap-1">

                    <button class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">
                        <a
                                href="{% url 'stock_detail_view' stock.uuid %}">View</a>
                    </button>

                    {% if request.user|has_perm:"stock.change_stock" %}
                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">

                            <a href="{% url 'stock_view' stock.uuid %}">Edit</a>
                        </button>
                        <button
                                type="button"
                                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                                onclick="openModal('{{ stock.uuid }}','reset')"
                        >
                            Reset
                        </button>
                    {% endif %}
                </div>

            </td>
            {% empty %}
        <tr>
            <td colspan="6" class="text-center p-4 text-gray-500">No Rows Found</td>
        </tr>
    {% endfor %}
{% endblock %}



{% block pagination %}
    {% with paginated_stocks as paginated_items %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

{% block modals %}
    <div id="resetModal" class="fixed inset-0 hidden justify-center items-center z-60
            backdrop-blur-sm bg-white/10">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-md">
            <p class="text-lg text-gray-800">Are you sure you want to Reset the Stock?
                <span class="text-sm text-gray-500">(This will clear stock quantity, price, and discount)</span>
            </p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('reset')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <form id="resetForm" method="post" action="">
                    {% csrf_token %}
                    {#                        this hidden input is sent inorder to send reset name for understanding post request#}
                    <input type="hidden" name="reset" value="1">
                    <button type="submit" name="reset"
                            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes,
                        Reset
                    </button>
                </form>
            </div>
        </div>

    </div>
{% endblock %}


{% block search_url %}/books/search/{% endblock %}
{% block response_data_key %}books{% endblock %}
{% block modal_form_action %}/admin-panel/stock/reset/{% endblock %}


{% block base_script %}
    {{ block.super }}
    <script>
        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const options = {year: "numeric", month: "short", day: "numeric"};
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, options); // e.g., "May 15, 2023"
        }

        {#Override the renderItems function for books#}

        function renderItems(books) {
            if (books.length === 0) {
                tableBody.innerHTML = `
    <tr>
        <td colspan="9" class="text-center p-4 text-gray-500">No Rows Found</td>
    </tr>`
                return;
            }

            tableBody.innerHTML = books.map((book, index) => {


                // cover image or fallback
                const coverImage = book.cover_image
                    ? `<img src="${book.cover_image}" alt="${book.title}" class="h-10 w-8 object-cover"/>`
                    : `<span class="italic text-gray-400">No cover available</span>`;

                // publisher
                const publisher = book.publisher || "-";

                // stock price
                const price = book.stock?.price != null
                    ? `Rs ${parseFloat(book.stock.price).toFixed(2).replace(/\.?0+$/, "")}`
                    : "-";

                // discount
                const discount = (book.stock && book.stock.discount_percentage != null)
                    ? `${parseFloat(book.stock.discount_percentage).toFixed(2).replace(/\.?0+$/, "")}% → Rs
    ${parseFloat(book.stock.discount_amount).toFixed(2).replace(/\.?0+$/, "")}`
                    : "-";

                // stock quantity
                const stockQty = book.stock?.stock_quantity ?? "-";

                // availability
                const availability = book.stock?.is_available
                    ? `<span class="text-green-600 font-semibold">Yes</span>`
                    : `<span class="text-red-600 font-semibold">No</span>`;

                // last restock date
                const lastRestock = book.stock?.last_restock_date || "-";

                return `
    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-300'}">
        <td class="p-3 text-sm text-gray-700">${coverImage}</td>
        <td class="p-3 text-sm text-gray-700">${book.title}</td>
        <td class="p-3 text-sm text-gray-700 text-center">${price}</td>
        <td class="p-3 text-sm text-gray-700 text-center">${discount}</td>
        <td class="p-3 text-sm text-gray-700 text-center">${stockQty}</td>
        {#<td class="p-3 text-sm text-gray-700">${availability}</td>#}
{#        <td class="p-3 text-sm text-gray-700">${formatDate(lastRestock)}</td>#}
        <td class="p-3 text-sm text-gray-700">
            <div class="flex space-x-2 gap-1">
                <a href="/admin-panel/stock/detail/${book.stock?.uuid}"
                   class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">View</a>

                <a href="/admin-panel/stock/edit/${book.stock?.uuid}"
                   class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Edit</a>
                <button onclick="openModal('${book.stock?.uuid}','reset')"
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Reset
                </button>

            </div>
        </td>
    </tr>
    `;
            }).join('');
        }


    </script>
{% endblock %}
