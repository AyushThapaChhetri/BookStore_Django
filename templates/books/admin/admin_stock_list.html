{#{% extends 'books/admin/admin_base_list.html' %}#}
{#{% load permissions %}#}
{##}
{##}
{#{% block list_title %}Stock List{% endblock %}#}
{##}
{#{% block list_heading %}Stocks{% endblock %}#}
{##}
{#{% block list_description %}#}
{#    This section provides a detailed overview of all available books in#}
{#    stock, including#}
{#    key information#}
{#    such as the title, authors, number of pages, language, and current availability. It helps you#}
{#    quickly assess which books are ready for purchase or restocking.#}
{#{% endblock %}#}
{##}
{##}
{#{% block search_placeholder %}Search Titles, Publisher{% endblock %}#}
{##}
{#{% block sort_options %}#}
{#    <option value="price_asc" {% if request.GET.sort == "price_asc" %}selected{% endif %}>#}
{#        Price (Low → High)#}
{#    </option>#}
{#    <option value="price_desc" {% if request.GET.sort == "price_desc" %}selected{% endif %}>#}
{#        Price (High → Low)#}
{#    </option>#}
{#    <option value="quantity_desc" {% if request.GET.sort == "quantity_desc" %}selected{% endif %}>#}
{#        Stock (High → Low)#}
{#    </option>#}
{#    <option value="quantity_asc" {% if request.GET.sort == "quantity_asc" %}selected{% endif %}>#}
{#        Stock (Low → High)#}
{#    </option>#}
{#    <option value="available_first" {% if request.GET.sort == "available_first" %}selected{% endif %}>#}
{#        Available First#}
{#    </option>#}
{#    <option value="unavailable_first" {% if request.GET.sort == "unavailable_first" %}selected{% endif %}>#}
{#        Unavailable First#}
{#    </option>#}
{#    <option value="restock_desc" {% if request.GET.sort == "restock_desc" %}selected{% endif %}>#}
{#        Recently Restocked#}
{#    </option>#}
{#    <option value="restock_asc" {% if request.GET.sort == "restock_asc" %}selected{% endif %}>#}
{#        Oldest Restock#}
{#    </option>#}
{#    <option value="created_desc" {% if request.GET.sort == "created_desc" %}selected{% endif %}>#}
{#        Created (Newest)#}
{#    </option>#}
{#    <option value="created_asc" {% if request.GET.sort == "created_asc" %}selected{% endif %}>#}
{#        Created (Oldest)#}
{#    </option>#}
{#{% endblock %}#}
{##}
{#{% block date_filter %}#}
{#    <form id="stock-datefilter-form" class="flex h-fit gap-4 flex-wrap items-center">#}
{#        <div class="flex items-center gap-4">#}
{#            {% include 'components/date_filter.html' %}#}
{#            <button type="button" class="bg-blue-600 text-white px-3 py-1 rounded">Filter</button>#}
{#        </div>#}
{#    </form>#}
{#{% endblock %}#}
{##}
{#{% block add_perm %}stocks.add_stock{% endblock %}#}
{#{% block sort_title_asc %}Titles{% endblock %}#}
{#{% block sort_title_desc %}Titles{% endblock %}#}
{#{% block add_button %}{% endblock %}#}
{##}
{##}
{#{% block table_headers %}#}
{#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Cover</th>#}
{#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Title</th>#}
{#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide  text-center">Price</th>#}
{#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide  text-center">Discount</th>#}
{#    <th class="py-3 px-5 text-sm font-semibold tracking-wide  text-center">Quantity</th>#}
{#    <th class="min-w-48 py-3 px-5 text-sm font-semibold tracking-wide  text-center">Cost of Goods</th>#}
{##}
{#{% endblock %}#}
{#{% block columns_count %}7{% endblock %}#}
{#{% block table_body %}#}
{#    {% for stock in paginated_stocks %}#}
{#        <tr class="{% if forloop.counter|divisibleby:2 %}bg-gray-300{% else %}bg-gray-50{% endif %}">#}
{#            <td class="p-3 text-sm text-gray-700"> {% if stock.book.cover_image %}#}
{#                <img src="{{ stock.book.cover_image.url }}"#}
{#                     alt="{{ stock.book.title }}"#}
{#                     class="h-10 w-8 object-cover"/>#}
{#            {% else %}#}
{#                <span class="italic text-gray-400">No cover available</span>#}
{#            {% endif %}</td>#}
{#            <td class="p-3 text-sm text-gray-700">{{ stock.book.title }}</td>#}
{#            <td class="p-3 text-sm text-gray-700 text-center">#}
{#                {% if stock.current_price %}#}
{#                    Rs {{ stock.current_price|floatformat:"-2" }}#}
{#                {% else %}#}
{#                    -#}
{#                {% endif %}#}
{#            </td>#}
{#            <td class="p-3 text-sm text-gray-700 text-center">{% if stock.current_discount_percentage %}#}
{#                {{ stock.current_discount_percentage|floatformat:-2 }}% → Rs#}
{#                {{ stock.discount_amount|floatformat:"2"|floatformat:"g" }}#}
{#            {% else %}#}
{#                -#}
{#            {% endif %}</td>#}
{#            <td class="p-3 text-sm text-gray-700 text-center">#}
{#                {{ stock.total_quantity|default:'-' }}</td>#}
{#            <td class="p-3 text-sm text-gray-700 text-center">#}
{#                {% if not stock.costofgoods == 0 %}#}
{#                    {{ stock.costofgoods|default:'-'|floatformat:"-2" }}#}
{#                {% else %}#}
{#                    -#}
{#                {% endif %}#}
{#            </td>#}
{##}
{##}
{#            <td class="p-3 text-sm text-gray-700">#}
{#                <div class="flex  space-x-2 gap-1">#}
{##}
{#                    <button class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">#}
{#                        <a href="{% url 'stock_detail' stock.book.uuid %}">View</a>#}
{#                    </button>#}
{##}
{##}
{#                </div>#}
{##}
{#            </td>#}
{#            {% empty %}#}
{#        <tr>#}
{#            <td colspan="6" class="text-center p-4 text-gray-500">No Rows Found</td>#}
{#        </tr>#}
{#    {% endfor %}#}
{#{% endblock %}#}
{##}
{##}
{##}
{#{% block pagination %}#}
{#    {% with paginated_stocks as paginated_items %}#}
{#        {{ block.super }}#}
{#    {% endwith %}#}
{#{% endblock %}#}
{##}
{#{% block modals %}#}
{#    <div id="resetModal" class="fixed inset-0 hidden justify-center items-center z-60#}
{#            backdrop-blur-sm bg-white/10">#}
{#        <div class="bg-white rounded-lg p-6 w-[90%] max-w-md">#}
{#            <p class="text-lg text-gray-800">Are you sure you want to Reset the Stock?#}
{#                <span class="text-sm text-gray-500">(This will clear stock quantity, price, and discount)</span>#}
{#            </p>#}
{#            <div class="flex justify-end gap-3">#}
{#                <button onclick="closeModal('reset')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">#}
{#                    Cancel#}
{#                </button>#}
{#                <form id="resetForm" method="post" action="">#}
{#                    {% csrf_token %}#}
{##}
{#                    <input type="hidden" name="reset" value="1">#}
{#                    <button type="submit" name="reset"#}
{#                            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes,#}
{#                        Reset#}
{#                    </button>#}
{#                </form>#}
{#            </div>#}
{#        </div>#}
{##}
{#    </div>#}
{#{% endblock %}#}
{##}
{##}
{#{% block search_url %}/admin-panel/books/search/{% endblock %}#}
{#{% block response_data_key %}books{% endblock %}#}
{#{% block modal_form_action %}/admin-panel/stock/reset/{% endblock %}#}
{##}
{##}
{#<script>#}
{##}
{##}
{#    function formatDate(dateStr) {#}
{#        if (!dateStr) return "-";#}
{#        const options = {year: "numeric", month: "short", day: "numeric"};#}
{#        const date = new Date(dateStr);#}
{#        return date.toLocaleDateString(undefined, options);#}
{#    }#}
{##}
{##}
{#    function renderItems(books) {#}
{#        if (books.length === 0) {#}
{#            tableBody.innerHTML = `#}
{#<tr>#}
{#    <td colspan="9" class="text-center p-4 text-gray-500">No Rows Found</td>#}
{#</tr>`#}
{#            return;#}
{#        }#}
{##}
{#        tableBody.innerHTML = books.map((book, index) => {#}
{##}
{##}
{#// cover image or fallback#}
{#            const coverImage = book.cover_image#}
{#                ? `<img src="${book.cover_image}" alt="${book.title}" class="h-10 w-8 object-cover"/>`#}
{#                : `<span class="italic text-gray-400">No cover available</span>`;#}
{##}
{#// publisher#}
{#            const publisher = book.publisher || "-";#}
{##}
{#// stock price#}
{#            const price = book.stock?.price != null#}
{#                ? `Rs ${parseFloat(book.stock.price).toFixed(2).replace(/\.?0+$/, "")}`#}
{#                : "-";#}
{##}
{#// discount#}
{#            const discount = (book.stock && book.stock.current_discount_percentage != null)#}
{#                ? `${parseFloat(book.stock.current_discount_percentage).toFixed(2).replace(/\.?0+$/, "")}% → Rs#}
{#${parseFloat(book.stock.discount_amount).toFixed(2).replace(/\.?0+$/, "")}`#}
{#                : "-";#}
{##}
{#// stock quantity#}
{#            const stockQty = book.stock?.stock_quantity ?? "-";#}
{##}
{#// availability#}
{#            const availability = book.stock?.is_available#}
{#                ? `<span class="text-green-600 font-semibold">Yes</span>`#}
{#                : `<span class="text-red-600 font-semibold">No</span>`;#}
{##}
{#// last restock date#}
{#            const lastRestock = book.stock?.last_restock_date || "-";#}
{##}
{#            return `#}
{#<tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-300'}">#}
{#    <td class="p-3 text-sm text-gray-700">${coverImage}</td>#}
{#    <td class="p-3 text-sm text-gray-700">${book.title}</td>#}
{#    <td class="p-3 text-sm text-gray-700 text-center">${price}</td>#}
{#    <td class="p-3 text-sm text-gray-700 text-center">${discount}</td>#}
{#    <td class="p-3 text-sm text-gray-700 text-center">${stockQty}</td>#}
{#   #}
{#    <td class="p-3 text-sm text-gray-700">#}
{#        <div class="flex space-x-2 gap-1">#}
{#            #}
{#            <a href="/admin-panel/stocked/detail/${book.uuid}"#}
{#               class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">View</a>#}
{##}
{#            #}
{#        </div>#}
{#    </td>#}
{#</tr>#}
{#`;#}
{#        }).join('');#}
{#    }#}
{##}
{##}
{#</script>#}
{#{% block base_script %}#}
{#    {{ block.super }}#}
{#    <script>#}
{#        document.addEventListener("DOMContentLoaded", () => {#}
{#            console.log("DOM Content Loaded - Initializing date filter");#}
{##}
{#            const form = document.getElementById("stock-datefilter-form");#}
{#            const tableContainer = document.getElementById("table-body");#}
{##}
{#            if (!form) {#}
{#                console.error("Form not found!");#}
{#                return;#}
{#            }#}
{#            if (!tableContainer) {#}
{#                console.error("Table container not found!");#}
{#                return;#}
{#            }#}
{##}
{#            console.log("Form found:", form);#}
{#            console.log("Table container found:", tableContainer);#}
{##}
{#            // Prevent default form submission and handle with AJAX#}
{#            form.addEventListener("submit", (e) => {#}
{#                e.preventDefault();#}
{#                console.log("Filter submit intercepted!");#}
{#                fetchData();#}
{#            });#}
{##}
{#            // Also listen to date input changes#}
{#            const dateInput = document.getElementById("datefilter");#}
{#            if (dateInput) {#}
{#                dateInput.addEventListener("change", () => {#}
{#                    console.log("Date changed:", dateInput.value);#}
{#                });#}
{#            }#}
{##}
{#            function buildQuery() {#}
{#                const params = new URLSearchParams();#}
{#                const formData = new FormData(form);#}
{##}
{#                formData.forEach((value, key) => {#}
{#                    if (value) {#}
{#                        params.append(key, value);#}
{#                        console.log(`Adding param: ${key} = ${value}`);#}
{#                    }#}
{#                });#}
{##}
{#                // Also preserve existing URL params like sort, search, etc.#}
{#                const currentParams = new URLSearchParams(window.location.search);#}
{#                currentParams.forEach((value, key) => {#}
{#                    if (!params.has(key) && key !== 'page') {#}
{#                        params.append(key, value);#}
{#                    }#}
{#                });#}
{##}
{#                console.log("Query built:", params.toString());#}
{#                return params.toString();#}
{#            }#}
{##}
{#            function updateUrl(query) {#}
{#                const newUrl = `${window.location.pathname}?${query}`;#}
{#                console.log("Updating URL:", newUrl);#}
{#                window.history.replaceState(null, "", newUrl);#}
{#            }#}
{##}
{#            async function fetchAll(url) {#}
{#                console.log("Fetching:", url);#}
{#                try {#}
{#                    const response = await axios.get(url, {#}
{#                        headers: {#}
{#                            "X-Requested-With": "XMLHttpRequest"#}
{#                        },#}
{#                        params: {#}
{#                            ajax: 1#}
{#                        }#}
{#                    });#}
{##}
{#                    console.log("AJAX response received:", response.data);#}
{##}
{#                    if (response.data.table_html) {#}
{#                        tableContainer.innerHTML = response.data.table_html;#}
{#                        console.log("Table updated successfully");#}
{#                    } else {#}
{#                        console.warn("No table_html in response");#}
{#                    }#}
{#                } catch (err) {#}
{#                    console.error("AJAX error:", err);#}
{#                    if (err.response) {#}
{#                        console.error("Error response:", err.response.data);#}
{#                        console.error("Error status:", err.response.status);#}
{#                    }#}
{#                }#}
{#            }#}
{##}
{#            function fetchData() {#}
{#                const query = buildQuery();#}
{#                updateUrl(query);#}
{#                const url = `${window.location.pathname}?${query}`;#}
{#                fetchAll(url);#}
{#            }#}
{#        });#}
{#    </script>#}
{#{% endblock %}#}


{% extends 'books/admin/admin_base_list.html' %}
{% load permissions %}

{% block list_title %}Stock List{% endblock %}
{% block list_heading %}Stocks{% endblock %}

{% block list_description %}
    This section provides a detailed overview of all available books in stock, including key information
    such as the title, authors, number of pages, language, and current availability. It helps you
    quickly assess which books are ready for purchase or restocking.
{% endblock %}

{% block search_placeholder %}Search Titles, Publisher{% endblock %}

{% block sort_options %}
    <option value="price_asc" {% if request.GET.sort == "price_asc" %}selected{% endif %}>
        Price (Low → High)
    </option>
    <option value="price_desc" {% if request.GET.sort == "price_desc" %}selected{% endif %}>
        Price (High → Low)
    </option>
    <option value="quantity_desc" {% if request.GET.sort == "quantity_desc" %}selected{% endif %}>
        Stock (High → Low)
    </option>
    <option value="quantity_asc" {% if request.GET.sort == "quantity_asc" %}selected{% endif %}>
        Stock (Low → High)
    </option>
    <option value="available_first" {% if request.GET.sort == "available_first" %}selected{% endif %}>
        Available First
    </option>
    <option value="unavailable_first" {% if request.GET.sort == "unavailable_first" %}selected{% endif %}>
        Unavailable First
    </option>
    <option value="restock_desc" {% if request.GET.sort == "restock_desc" %}selected{% endif %}>
        Recently Restocked
    </option>
    <option value="restock_asc" {% if request.GET.sort == "restock_asc" %}selected{% endif %}>
        Oldest Restock
    </option>
    <option value="created_desc" {% if request.GET.sort == "created_desc" %}selected{% endif %}>
        Created (Newest)
    </option>
    <option value="created_asc" {% if request.GET.sort == "created_asc" %}selected{% endif %}>
        Created (Oldest)
    </option>
{% endblock %}

{% block date_filter %}
    <form id="stock-datefilter-form" class="flex h-fit gap-4 flex-wrap items-center">
        <div class="flex items-center gap-4">
            {% include 'components/date_filter.html' %}
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                Filter
            </button>
        </div>
    </form>
{% endblock %}

{% block add_perm %}stocks.add_stock{% endblock %}
{% block sort_title_asc %}Titles{% endblock %}
{% block sort_title_desc %}Titles{% endblock %}
{% block add_button %}{% endblock %}

{% block table_headers %}
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Cover</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Title</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-center">Price</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-center">Discount</th>
    <th class="py-3 px-5 text-sm font-semibold tracking-wide text-center">Quantity</th>
    <th class="min-w-48 py-3 px-5 text-sm font-semibold tracking-wide text-center">Cost of Goods</th>
{% endblock %}

{% block columns_count %}7{% endblock %}

{% block table_body %}
    {% for stock in paginated_stocks %}
        <tr class="{% if forloop.counter|divisibleby:2 %}bg-gray-300{% else %}bg-gray-50{% endif %}">
            <td class="p-3 text-sm text-gray-700">
                {% if stock.book.cover_image %}
                    <img src="{{ stock.book.cover_image.url }}"
                         alt="{{ stock.book.title }}"
                         class="h-10 w-8 object-cover"/>
                {% else %}
                    <span class="italic text-gray-400">No cover available</span>
                {% endif %}
            </td>
            <td class="p-3 text-sm text-gray-700">{{ stock.book.title }}</td>
            <td class="p-3 text-sm text-gray-700 text-center">
                {% if stock.current_price %}
                    Rs {{ stock.current_price|floatformat:"-2" }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="p-3 text-sm text-gray-700 text-center">
                {% if stock.current_discount_percentage %}
                    {{ stock.current_discount_percentage|floatformat:-2 }}% → Rs
                    {{ stock.discount_amount|floatformat:"2"|floatformat:"g" }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="p-3 text-sm text-gray-700 text-center">
                {{ stock.total_quantity|default:'-' }}
            </td>
            <td class="p-3 text-sm text-gray-700 text-center">
                {% if not stock.costofgoods == 0 %}
                    {{ stock.costofgoods|default:'-'|floatformat:"-2" }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="p-3 text-sm text-gray-700">
                <div class="flex space-x-2 gap-1">
                    <button class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">
                        <a href="{% url 'stock_detail' stock.book.uuid %}">View</a>
                    </button>
                </div>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="7" class="text-center p-4 text-gray-500">No Rows Found</td>
        </tr>
    {% endfor %}
{% endblock %}

{% block pagination %}
    {% with paginated_stocks as paginated_items %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

{% block modals %}
    <div id="resetModal" class="fixed inset-0 hidden justify-center items-center z-60 backdrop-blur-sm bg-white/10">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-md">
            <p class="text-lg text-gray-800">
                Are you sure you want to Reset the Stock?
                <span class="text-sm text-gray-500">(This will clear stock quantity, price, and discount)</span>
            </p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('reset')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <form id="resetForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="reset" value="1">
                    <button type="submit" name="reset"
                            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Yes, Reset
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block search_url %}/admin-panel/books/search/{% endblock %}
{% block response_data_key %}books{% endblock %}
{% block modal_form_action %}/admin-panel/stock/reset/{% endblock %}

{% block base_script %}
    {{ block.super }}
    <script>
        console.log("Stock list script loading...");

        document.addEventListener("DOMContentLoaded", () => {
            console.log("=== Stock Date Filter Initialization ===");

            const form = document.getElementById("stock-datefilter-form");
            const tableContainer = document.getElementById("listTableBody");

            console.log("Form element:", form);
            console.log("Table container:", tableContainer);

            if (!form) {
                console.error(" Form #stock-datefilter-form not found!");
                return;
            }

            if (!tableContainer) {
                console.error(" Table container #listTableBody not found!");
                return;
            }

            console.log("✓ Both form and table container found");

            // Handle form submission
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                console.log(" Form submit event triggered!");
                fetchData();
            });

            // Also add click listener to button for debugging
            const button = form.querySelector("button[type='submit']");
            if (button) {
                button.addEventListener("click", (e) => {
                    console.log(" Button clicked!");
                });
            }

            // Listen to date input changes
            const dateInput = document.getElementById("datefilter");
            if (dateInput) {
                console.log("Date input found:", dateInput);
                dateInput.addEventListener("change", () => {
                    console.log(" Date changed to:", dateInput.value);
                });
            } else {
                console.warn(" Date input #datefilter not found");
            }

            function buildQuery() {
                console.log(" Building query parameters...");
                const params = new URLSearchParams();
                const formData = new FormData(form);

                formData.forEach((value, key) => {
                    if (value) {
                        params.append(key, value);
                        console.log(`Adding param: ${key} = ${value}`);
                    }
                });

                // Preserve existing URL params
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.forEach((value, key) => {
                    if (!params.has(key) && key !== 'page') {
                        params.append(key, value);
                        console.log(` Preserving param: ${key} = ${value}`);
                    }
                });

                const queryString = params.toString();
                console.log("✓ Query built:", queryString);
                return queryString;
            }

            function updateUrl(query) {
                const newUrl = `${window.location.pathname}?${query}`;
                console.log("Updating URL to:", newUrl);
                window.history.replaceState(null, "", newUrl);
            }

            async function fetchAll(url) {
                console.log("Fetching data from:", url);

                try {
                    const response = await axios.get(url, {
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });

                    console.log("✓ Response received:", response.data);

                    if (response.data.table_html) {
                        tableContainer.innerHTML = response.data.table_html;
                        console.log("✓ Table updated successfully!");
                    } else {
                        console.warn("No table_html in response");
                        console.log("Response keys:", Object.keys(response.data));
                    }

                } catch (err) {
                    console.error("AJAX error:", err);
                    if (err.response) {
                        console.error("  Error data:", err.response.data);
                        console.error("  Error status:", err.response.status);
                        console.error("  Error headers:", err.response.headers);
                    } else if (err.request) {
                        console.error("  No response received:", err.request);
                    } else {
                        console.error("  Error message:", err.message);
                    }
                }
            }

            function fetchData() {
                console.log("fetchData() called");
                const query = buildQuery();
                updateUrl(query);
                const url = `${window.location.pathname}?${query}`;
                fetchAll(url);
            }

            console.log("=== Date filter setup complete ===");
        });
    </script>
{% endblock %}

