{% extends 'books/admin/Stock/admin_reusable_stock.html' %}
{% load static %}
{% block title %}Stock History{% endblock %}
{% block heading_title_stock %}Stock History{% endblock %}

{% block search_and_filters_stock %}
    <form id="stock-filter-form" class="flex gap-4 flex-wrap p-4 ">

        {% include "books/components/text_filter.html" with label="Changed By" name="changed_by"  placeholder="Email" current_value=request.GET.changed_by %}
        {% include "books/components/select_filter.html" with  label="Change Type" name="change_type" options=change_type_options  current_value=request.GET.change_type %}

        <div class="flex flex-col ">
            <div class="flex items-center gap-4">
                {% include "components/date_range.html" with prefix="received" %}
                <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">Filter</button>

            </div>
            {% if min_date and max_date %}
                <p class="text-sm text-gray-500">
                    Select a date between <strong>{{ min_date }}</strong> to <strong>{{ max_date }}</strong> .
                </p>
            {% endif %}

        </div>

    </form>

    <div id="open-closing-quantity">
        {% include 'books/components/stock/stock_batch_openingClosing.html' with total_actual_cost_cost=total_actual_cost_cost total_actual_sold_cost=total_actual_sold_cost  total_profit_loss=total_profit_loss %}
    </div>
{% endblock %}

{% block table_rows %}
    {% include "books/admin/Stock/table/stock_history_table.html" %}
{% endblock %}
{% block pagination %}

    {% with paginated_stock_history as paginated_items %}
        {% include "books/admin/Stock/pagination/stock_pagination.html" with paginated_items=paginated_items limit=limit %}
    {% endwith %}
{% endblock %}

{% block extra_js %}

    {#    <script src="{% static 'core/js/reusable_stock_table.js' %}"></script>#}
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const form = document.getElementById("stock-filter-form");
            const tableContainer = document.getElementById("table-container");
            const paginationContainer = document.getElementById("pagination-container");
            const openingClosingContainer = document.getElementById("open-closing-quantity");

            if (!form || !tableContainer || !paginationContainer) {
                console.error("Missing required DOM elements.");
                return;
            }


            function buildQuery() {
                const params = new URLSearchParams();

                new FormData(form).forEach((value, key) => {
                    if (!value) return;
                    {#if (!includeDates && (key.endsWith("_from") || key.endsWith("_to"))) return;#}
                    params.append(key, value);
                });

                return params.toString();
            }


            function updateUrl(query) {
                const newUrl = `${window.location.pathname}?${query}`;
                window.history.replaceState(null, "", newUrl);
            }


            async function fetchAll(url) {
                try {
                    const errorSpans = form.querySelectorAll("span.text-red-500");
                    errorSpans.forEach(span => span.innerText = "");
                    const response = await axios.get(`${url}&ajax=1`, {
                        headers: {"X-Requested-With": "XMLHttpRequest"}
                    });

                    const data = response.data;
                    console.log("Beforeeeeee");

                    if (data.table_html) {
                        tableContainer.innerHTML = data.table_html;
                    }
                    if (data.pagination_html) {
                        paginationContainer.innerHTML = data.pagination_html;
                    }
                    if (data.opening_closing_html) {
                        openingClosingContainer.innerHTML = data.opening_closing_html;
                    }

                    attachPaginationEvents();

                } catch (err) {
                    console.error("Fetch error:", err);

                    console.log("afterrrrr");

                    if (err.response?.data?.errors) {
                        const errors = err.response.data.errors;
                        console.log("errors:", errors)

                        Object.keys(errors).forEach(key => {
                            let spanId = key;
                            if (key === "from") spanId = "received_from";
                            if (key === "to") spanId = "received_to";

                            const span = document.getElementById(`${spanId}_error`);
                            if (span) span.innerText = errors[key];
                        });


                        return;
                    }
                }
            }


            function attachPaginationEvents() {
                const links = paginationContainer.querySelectorAll(".ajax-page");

                links.forEach(link => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();

                        const urlObj = new URL(link.href, window.location.origin);
                        const page = urlObj.searchParams.get("page");

                        const query = new URLSearchParams(new FormData(form));
                        if (page) query.set("page", page);

                        const finalUrl = `${window.location.pathname}?${query.toString()}`;
                        updateUrl(query.toString());

                        fetchAll(finalUrl);
                    });
                });
            }


            function debounce(fn, delay = 600) {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            }


            const fetchData = () => {
                const query = buildQuery(true);
                updateUrl(query);
                const url = `${window.location.pathname}?${query}`;
                fetchAll(url);
            };

            form.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener("input", debounce(fetchData));
            });

            form.querySelectorAll("select").forEach(select => {
                select.addEventListener("change", fetchData);
            });


            form.addEventListener("submit", (e) => {
                e.preventDefault();
                fetchData();
            });


            attachPaginationEvents();

        });
    </script>


{% endblock %}
