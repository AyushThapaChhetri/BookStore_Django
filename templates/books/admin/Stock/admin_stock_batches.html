{% extends 'books/admin/Stock/admin_reusable_stock.html' %}
{% block title %}Batches{% endblock %}
{% block heading_title_stock %}Batches{% endblock %}

{% block search_and_filters_stock %}
    <form method="get" class="flex gap-4 flex-wrap p-4 ">
        {% include "books/components/text_filter.html" with label="Batch uuid" name="batch_uuid" placeholder="Search Batch uuid" current_value=request.GET.batch_uuid %}
        {% include "books/components/select_filter.html" with  label="Sort By" name="sort_by" options=sort_options  current_value=request.GET.sort_by %}

        <div class="flex items-center gap-4">
            {% include "components/date_range.html" with prefix="received" %}
            <button type="submit" class="bg-blue-600 h-fit text-white px-3 py-1 rounded">Filter</button>
        </div>
    </form>
    {#    <div id="open-closing-quantity">#}
    {##}
    {#        {% include 'books/components/stock/stock_batch_openingClosing.html' with total_actual_cost_cost=total_actual_cost_cost total_actual_sold_cost=total_actual_sold_cost  total_profit_loss=total_profit_loss %}#}
    {#    </div>#}

    <div class="flex items-center gap-2">
        <span class="text-sm font-medium text-gray-600">Total Stock:</span>

        <span class="px-3 py-1 rounded-xl bg-gray-100 text-gray-700 text-sm font-semibold">
            {{ total_stock_quantity_all_time }}
        </span>
    </div>

{% endblock %}

{% block table_rows %}
    {% include 'books/admin/Stock/table/Stock_Batch_table_rows.html' with paginated_batches=paginated_batches %}
    {% include 'components/form_popup.html' %}
{% endblock %}


{% block pagination %}
    {% with paginated_batches as paginated_items %}
        {% include "books/admin/Stock/pagination/stock_pagination.html" with paginated_items=paginated_items limit=limit %}
    {% endwith %}
{% endblock %}



{% block extra_js %}
    <script>
        const formPopup = document.getElementById('formPopupModal');
        const form_Container_popup = document.getElementById('form-Container-popup');


        async function openModal(bookUid, batchUid) {
            console.log("Hello");
            console.log('field uuid', bookUid)
            console.log('stock uuid', batchUid)
            try {

                console.log('why');
                console.log(`/admin-panel/stock/${bookUid}/restock/edit/${batchUid}`)
                const response = await axios.get(`/admin-panel/stock/${bookUid}/restock/edit/${batchUid}`, {
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                });


                form_Container_popup.dataset.batchUid = batchUid;

                formPopup.classList.remove("hidden");
                form_Container_popup.innerHTML = response.data.html;

            } catch (e) {
                console.log("error", e);
                alert(e);
            }


        }

        function closeLogoutModal() {
            console.log("logout");
            formPopup.classList.add("hidden")
        }


        async function fetchFilteredData() {
            const fromInput = document.getElementById("received_from");
            const toInput = document.getElementById("received_to");

            const from = fromInput.value;
            const to = toInput.value;

            // Clear previous errors
            const fromError = document.getElementById("received_from_error");
            const toError = document.getElementById("received_to_error");
            if (fromError) fromError.textContent = "";
            if (toError) toError.textContent = "";

            const params = new URLSearchParams(window.location.search);
            if (from) params.set("received_from", from);
            else params.delete("received_from");

            if (to) params.set("received_to", to);
            else params.delete("received_to");

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, "", newUrl);

            console.log("gggg")

            try {
                console.log("hhhhh")
                const response = await axios.get(newUrl, {
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });

                console.log("ccccc")
                console.log("response: ", response)
                {#console.log("response closing: ", response.data.opening_closing_html)#}

                {#document.getElementById("open-closing-quantity").innerHTML = response.data.opening_closing_html;#}
                const tableContainer = document.getElementById("table-container");
                const paginationContainer = document.getElementById("pagination-container");

                if (tableContainer && response.data.table_html) {
                    tableContainer.innerHTML = response.data.table_html;
                }
                if (paginationContainer && response.data.pagination_html) {
                    paginationContainer.innerHTML = response.data.pagination_html;
                }
            } catch (error) {
                console.log("hello")
                if (error.response && error.response.status === 400 && error.response.data.errors) {
                    const errs = error.response.data.errors;
                    if (errs.from && fromError) fromError.textContent = errs.from;
                    if (errs.to && toError) toError.textContent = errs.to;
                } else {
                    console.error("Filter AJAX error:", error);
                }
            }
        }

        document.querySelector("form").addEventListener("submit", async function (e) {
            e.preventDefault();
            await fetchFilteredData();
        });


        async function updateFilter(name, value) {
            const params = new URLSearchParams(window.location.search);

            if (value) params.set(name, value);
            else params.delete(name);

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, "", newUrl);

            try {

                const response = await axios.get(newUrl, {
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });


                document.getElementById("table-container").innerHTML = response.data.table_html;
                document.getElementById("pagination-container").innerHTML = response.data.pagination_html;

            } catch (error) {
                console.error("Sort filter AJAX error:", error);
            }
        }

        document.addEventListener("change", function (e) {
            console.log(e)
            if (e.target.matches(".filter-select")) {
                updateFilter("sort_by", e.target.value);
            }
        });


        document.addEventListener("click", async function (e) {
            if (e.target.matches(".ajax-page")) {
                e.preventDefault();

                console.log("gggg")
                try {
                    const response = await axios.get(e.target.href, {
                        headers: {"X-Requested-With": "XMLHttpRequest"}
                    });


                    document.getElementById("table-container").innerHTML =
                        response.data.table_html;

                    document.getElementById("pagination-container").innerHTML =
                        response.data.pagination_html;

                } catch (error) {
                    console.error("Pagination AJAX error:", error);
                }
            }
        });


        function debounce(fn, delay) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        const batchInput = document.getElementById("batch_uuid");

        async function fetchUUIDResults() {
            const value = batchInput.value;
            const params = new URLSearchParams(window.location.search);

            if (value) params.set("batch_uuid", value);
            else params.delete("batch_uuid");

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, "", newUrl);

            try {
                const response = await axios.get(newUrl, {
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });

                document.getElementById("table-container").innerHTML =
                    response.data.table_html;

                document.getElementById("pagination-container").innerHTML =
                    response.data.pagination_html;

            } catch (e) {
                console.log("UUID search error:", e);
            }
        }


        batchInput.addEventListener("input", debounce(fetchUUIDResults, 300));
    </script>
{% endblock %}
