{% extends 'base/admin/admin_base.html' %}
{% load permissions %}

{% block title %}
    {% block list_title %}Default List{% endblock %}
{% endblock %}

{% block content %}
    <div class="flex flex-col h-full p-5 md:px-15 bg-blue-100 gap-4">
        <div class="flex flex-col space-between justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-4">
                    {% block list_heading %}Default Heading{% endblock %}
                </h1>
                <p class="italic text-gray-500">
                    {% block list_description %}Default description.{% endblock %}
                </p>
            </div>

            <div class="flex flex-col gap-4 md:flex-row md:justify-between md:items-center">
                {% block search_and_filters %}
                    <div class="flex gap-4 flex-col items-center lg:flex-row">
                        <form class="w-full md:w-[300px]">
                            <label for="searchInput"
                                   class="mb-2 text-sm font-medium text-gray-900 sr-only">Search</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                                    </svg>
                                </div>
                                <input type="search" id="searchInput"
                                       class="block w-full p-4 ps-10 text-[16px] text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="{% block search_placeholder %}Search{% endblock %}" required/>
                            </div>
                        </form>

                        <div class="flex flex-column flex-wrap gap-4 md:gap-20">
                            <div class="flex flex-row  items-center gap-2 w-fit">
                                <p>Sort by: </p>
                                <form class="max-w-sm mx-auto" method="get">
                                    <select id="sortBy" name="sort"
                                            class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg  focus:ring-blue-500 focus:border-blue-500 block w-fit p-2.5">

                                        {% block sort_options %}
                                            <option value="name_asc"
                                                    {% if request.GET.sort == "name_asc" %}selected{% endif %}>
                                                Name (A–Z)
                                            </option>
                                            <option value="name_desc"
                                                    {% if request.GET.sort == "name_desc" %}selected{% endif %}>
                                                Name (Z–A)
                                            </option>
                                            <option value="created_desc"
                                                    {% if request.GET.sort == "created_desc" %}selected{% endif %}>
                                                Created (Newest)
                                            </option>
                                            <option value="created_asc"
                                                    {% if request.GET.sort == "created_asc" %}selected{% endif %}>
                                                Created (Oldest)
                                            </option>
                                        {% endblock %}
                                    </select>
                                </form>
                            </div>
                        </div>
                        {% block date_filter %}

                        {% endblock %}
                    </div>



                {% endblock %}
                {% if not is_recycle_bin %}
                    {% block add_button %}


                        <button
                                type="button"
                                class="w-fit h-fit bg-indigo-800 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded"
                                onclick="window.location.href='{% block add_url %}#{% endblock %}'"
                        >

                            Add {% block entity_name %}
                            Entity{% endblock %}

                        </button>

                    {% endblock %}
                {% endif %}

            </div>
        </div>
        <div class="overflow-y-hidden rounded-lg shadow">
            <table class="w-full">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                <tr>
                    {% block table_headers %}
                        <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Default Header</th>
                    {% endblock %}
                    <th class="p-3 text-sm font-semibold tracking-wide text-left">Actions</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="listTableBody">
                {% block table_body %}
                    <tr>
                        <td colspan="{% block columns_count %}1{% endblock %}" class="text-center p-4 text-gray-500">
                            No Rows Found
                        </td>
                    </tr>
                {% endblock %}
                </tbody>
            </table>
        </div>

        {% block pagination %}
            {% if paginated_items %}
                <div class="w-full flex flex-wrap flex-column justify-between items-center">
                    Page {{ paginated_items.number }} of {{ paginated_items.paginator.num_pages }}

                    <div class="flex flex-column flex-wrap gap-4 md:gap-20">
                        <div class="flex flex-row items-center gap-2 w-fit">
                            <p>Show: </p>
                            <form class="max-w-sm mx-auto" method="get">
                                <select id="rowsPerPage" name="limit"
                                        class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-fit p-2.5">
                                    <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                                    <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
                                    <option value="30" {% if limit == 30 %}selected{% endif %}>30</option>
                                    <option value="40" {% if limit == 40 %}selected{% endif %}>40</option>
                                    <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                                </select>
                            </form>
                        </div>
                        <div class="flex flex-column">
                            <!-- First Page -->
                            <div class="flex p-1 border border-gray-300 items-center">
                                {% if paginated_items.has_previous %}
                                    <a href="?page=1&limit={{ limit }}">
                                {% else %}
                                    <a class="pointer-event-none text-gray-300">
                                {% endif %}
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5"/>
                                </svg>
                                </a>
                            </div>

                            <!-- Previous Page -->
                            <div class="flex p-1 border border-gray-300 items-center">
                                {% if paginated_items.has_previous %}
                                    <a href="?page={{ paginated_items.previous_page_number }}&limit={{ limit }}">
                                {% else %}
                                    <a class="pointer-event-none text-gray-300">
                                {% endif %}
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M15.75 19.5 8.25 12l7.5-7.5"/>
                                </svg>
                                </a>
                            </div>

                            <div class="flex py-1 px-3 border border-gray-300 items-center">
                                {{ paginated_items.number }}
                            </div>

                            <!-- Next Page -->
                            <div class="flex p-1 border border-gray-300 items-center">
                                {% if paginated_items.has_next %}
                                    <a href="?page={{ paginated_items.next_page_number }}&limit={{ limit }}">
                                {% else %}
                                    <a class="pointer-event-none text-gray-300">
                                {% endif %}
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"/>
                                </svg>
                                </a>
                            </div>

                            <!-- Last Page -->
                            <div class="flex p-1 border border-gray-300 items-center">
                                {% if paginated_items.has_next %}
                                    <a href="?page={{ paginated_items.paginator.num_pages }}&limit={{ limit }}">
                                {% else %}
                                    <a class="pointer-event-none text-gray-300">
                                {% endif %}
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5"/>
                                </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endblock %}

        {% block modals %}

        {% endblock %}

    </div>
    {% block base_script %}
        <script>

            document.addEventListener("DOMContentLoaded", () => {

                const tableBody = document.getElementById("listTableBody");
                const searchInput = document.getElementById("searchInput");
                const sortSelect = document.getElementById("sortBy");
                const dateFilterForm = document.getElementById("stock-datefilter-form") || null;
                const dateInput = document.getElementById("datefilter");


                function debounce(func, delay) {
                    let t;
                    return (...args) => {
                        clearTimeout(t);
                        t = setTimeout(() => func(...args), delay);
                    };
                }


                function buildQuery() {
                    const params = new URLSearchParams();

                    if (searchInput?.value.trim()) {
                        params.set("q", searchInput.value.trim());
                    }

                    if (sortSelect?.value) {
                        params.set("sort", sortSelect.value);
                    }

                    if (dateInput?.value) {
                        params.set("datefilter", dateInput.value);
                    }

                    const current = new URLSearchParams(window.location.search);
                    if (current.get("limit")) params.set("limit", current.get("limit"));
                    if (current.get("page")) params.set("page", current.get("page"));

                    return params.toString();
                }


                function syncUI() {
                    const p = new URLSearchParams(window.location.search);

                    if (p.get("q") && searchInput) searchInput.value = p.get("q");
                    if (p.get("sort") && sortSelect) sortSelect.value = p.get("sort");
                    if (p.get("datefilter") && dateInput) dateInput.value = p.get("datefilter");
                }


                function updateUrl(q) {
                    const newUrl = `${window.location.pathname}?${q}`;
                    window.history.pushState({}, "", newUrl);
                }


                async function fetchTable() {
                    try {
                        const url = `${window.location.pathname}${window.location.search}`;
                        const response = await axios.get(url, {
                            headers: {"X-Requested-With": "XMLHttpRequest"}
                        });

                        tableBody.innerHTML = response.data.table_html;
                        syncUI();

                    } catch (err) {
                        console.error("AJAX fetch failed:", err);
                    }
                }


                if (searchInput) {

                    searchInput.addEventListener("input", debounce(() => {
                        const q = buildQuery();
                        updateUrl(q);
                        fetchTable();
                    }, 500));

                    searchInput.addEventListener("keydown", e => {
                        if (e.key === "Enter") e.preventDefault();
                    });
                }


                if (sortSelect) {
                    sortSelect.addEventListener("change", () => {
                        const q = buildQuery();
                        updateUrl(q);
                        fetchTable();
                    });
                }


                if (dateFilterForm) {
                    dateFilterForm.addEventListener("submit", e => {
                        e.preventDefault();
                        const q = buildQuery();
                        updateUrl(q);
                        fetchTable();
                    });
                }


                document.addEventListener("click", (e) => {
                    const a = e.target.closest("a");
                    if (!a) return;

                    if (!a.href.includes("?page=")) return;

                    e.preventDefault();

                    const url = new URL(a.href);
                    const page = url.searchParams.get("page");

                    const params = new URLSearchParams(window.location.search);
                    params.set("page", page);

                    updateUrl(params.toString());
                    fetchTable();
                });


                window.addEventListener("popstate", () => {
                    fetchTable();
                });


                syncUI();

            });

        </script>
    {% endblock %}

{% endblock %}