{% extends 'books/admin/admin_base_list.html' %}
{% load permissions %}


{% block list_title %}Order List{% endblock %}

{% block list_heading %}Order{% endblock %}

{% block list_description %}
    This section provides a detailed overview of all available Orders of
    Book.
{% endblock %}


{% block search_placeholder %}Search Orders, Email {% endblock %}

{% block add_perm %}orders.add_publisher{% endblock %}
{% block sort_title_asc %}Name{% endblock %}
{% block sort_title_desc %}Name{% endblock %}
{% block sort_options %}

    <option value="created_desc" {% if request.GET.sort == "created_desc" %}selected{% endif %}>
        Created (Newest)
    </option>

    <option value="created_asc" {% if request.GET.sort == "created_asc" %}selected{% endif %}>
        Created (Oldest)
    </option>

{% endblock %}
{% block add_url %}
    {#    {% url 'publisher_view' %}#}
    #
{% endblock %}
{% block add_button %}
    <div class="flex flex-column flex-wrap gap-4 md:gap-20">
        <div class="flex flex-row items-center gap-2 w-fit">

            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600">Show</label>

                <form method="get">
                    <select name="showby"
                            onchange="this.form.submit()"
                            class="border rounded px-3 py-2 bg-gray-100 text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500">

                        <option value="">All</option>

                        <option value="completed" {% if request.GET.showby == "completed" %}selected{% endif %}>
                            Completed
                        </option>

                        <option value="pending" {% if request.GET.showby == "pending" %}selected{% endif %}>
                            Pending
                        </option>

                        <option value="cancelled" {% if request.GET.showby == "cancelled" %}selected{% endif %}>
                            Cancelled
                        </option>
                    </select>
                </form>

            </div>

        </div>
    </div>
{% endblock %}
{% block entity_name %}Publisher{% endblock %}

{% block table_headers %}
    {#    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Cover Image</th>#}
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Order Id</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Ordered By</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Total Amount</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Order Date</th>
    <th class="min-w-48 p-3 text-sm font-semibold tracking-wide text-left">Status</th>

{% endblock %}
{% block columns_count %}6{% endblock %}

{% block table_body %}
    {% for order in paginated_order %}
        <tr class="{% if forloop.counter|divisibleby:2 %}bg-gray-300{% else %}bg-gray-50{% endif %}">

            <td class="p-3 text-sm text-gray-700">{{ order.uuid }}</td>
            <td class="p-3 text-sm text-gray-700">{{ order.user.email|default:"-" }}</td>
            <td class="p-3 text-sm text-gray-700">{{ order.total_amount|default:"-" }}</td>
            <td class="p-3 text-sm text-gray-700">{{ order.order_date|default:"-" }}</td>
            <td class="p-3 text-sm text-gray-700">

                <form class="order-status-form" data-order-id="{{ order.id }}">
                    {% csrf_token %}
                    <select name="status" class="form-select text-sm"
                            {% if order.status == 'completed' or order.status == 'cancelled' %}disabled{% endif %}>
                        {% for key, label in order.STATUS_CHOICES %}
                            <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </td>

            <td class="p-3 text-sm text-gray-700">
                <div class="flex  space-x-2 gap-1">

                    <button class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded">
                        {#                                            <a href="{% url 'order_detail_view' order.uuid %}">View</a>#}
                        <a href="{% url 'order_detail_view' order.uuid %}">
                            View
                        </a>
                    </button>


                </div>

            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="9" class="text-center p-4 text-gray-500">
                No Rows Found
            </td>
        </tr>
    {% endfor %}
{% endblock %}

{% block pagination %}
    {% with paginated_order as paginated_items %}
        {{ block.super }}
    {% endwith %}
{% endblock %}




{% block modals %}

{% endblock %}

{% block search_url %}
    /admin-panel/manage/order/list/
{% endblock %}

{% block response_data_key %}orders{% endblock %}

{% block base_script %}
    {{ block.super }}

    <script>
        document.querySelectorAll('.order-status-form select').forEach(select => {
            select.addEventListener('change', async function () {
                const form = this.closest('form');
                const orderId = form.dataset.orderId;
                const newStatus = this.value;
                const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                try {
                    const response = await axios.post(
                        `/admin-panel/orders/${orderId}/update-status/`,
                        {status: newStatus},
                        {
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            }
                        }
                    );


                    if (response.data.success) {
                        alert(`Order status updated to ${response.data.new_status}`);


                        if (['completed', 'cancelled'].includes(newStatus)) {
                            this.disabled = true;
                        }
                    } else {
                        alert(`Failed to update status: ${response.data.message}`);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating status. Try again.');
                }
            });
        });


        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, {year: "numeric", month: "short", day: "numeric"});
        }

        function renderItems(orders) {
            if (!orders || orders.length === 0) {
                tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4 text-gray-500">No Rows Found</td>
                </tr>`;
                return;
            }

            tableBody.innerHTML = orders.map((order, index) => {
                const orderId = order.uuid || "-";
                const userEmail = order.user_email || "-";
                const totalAmount = order.total_amount != null ? order.total_amount : "-";
                const orderDate = formatDate(order.order_date);
                const status = order.status || "-";

                // Build status dropdown
                const isDisabled = (status === "completed" || status === "cancelled") ? "disabled" : "";
                const optionsHTML = (order.status_choices || []).map(([key, label]) => `
                <option value="${key}" ${status === key ? "selected" : ""}>
                    ${label}
                </option>
            `).join("");

                return `
                <tr class="${index % 2 === 0 ? "bg-gray-50" : "bg-gray-300"}">
                    <td class="p-3 text-sm text-gray-700">${orderId}</td>
                    <td class="p-3 text-sm text-gray-700">${userEmail}</td>
                    <td class="p-3 text-sm text-gray-700">${totalAmount}</td>
                    <td class="p-3 text-sm text-gray-700">${orderDate}</td>
                    <td class="p-3 text-sm text-gray-700">
                        <form class="order-status-form" data-order-id="${order.id}">
                            <select name="status" class="form-select text-sm" ${isDisabled}>
                                ${optionsHTML}
                            </select>
                        </form>
                    </td>
                    <td class="p-3 text-sm text-gray-700">
                        <div class="flex space-x-2 gap-1">
                            <button class="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded"
                                    onclick="window.location.href='/admin-panel/order/detail/${order.uuid}'">
                                View
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join("");
        }


    </script>
{% endblock %}

